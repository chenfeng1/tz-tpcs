<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns:security="http://www.springframework.org/schema/security"
             xmlns:beans="http://www.springframework.org/schema/beans"
             xmlns:context="http://www.springframework.org/schema/context"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://www.springframework.org/schema/beans
                        http://www.springframework.org/schema/beans/spring-beans.xsd
                        http://www.springframework.org/schema/context
                        http://www.springframework.org/schema/context/spring-context.xsd
                        http://www.springframework.org/schema/security
                        http://www.springframework.org/schema/security/spring-security.xsd">

    <context:annotation-config/>

    <security:http auto-config="true" use-expressions="true">
        <security:form-login
                    login-page="/login.jsp"
                    login-processing-url="/loginVerify"
                    username-parameter="j_username"
                    password-parameter="j_password"
                    authentication-success-handler-ref="customAuthenticationSuccessHandler"
                    authentication-failure-handler-ref="customAuthenticationFailureHandler"/>
        <!--匿名可访问-->
        <security:intercept-url pattern="/login.jsp" access="permitAll"/>
        <security:intercept-url pattern="/css*/**" access="permitAll"/>
        <security:intercept-url pattern="/js*/**" access="permitAll"/>
        <security:intercept-url pattern="/font/**" access="permitAll"/>
        <security:intercept-url pattern="/icon/**" access="permitAll"/>
        <security:intercept-url pattern="/images/**" access="permitAll"/>
        <security:intercept-url pattern="/html/**" access="permitAll"/>
        <!--登录授权可访问-->
        <security:intercept-url pattern="/**" access="isAuthenticated()"/>
        <!-- logout 跳转 url -->
        <security:logout logout-url="/logout" logout-success-url="/login.jsp"/>

        <security:session-management
                session-authentication-error-url="/html/sessionAuthenticationError.html"
                invalid-session-url="/login.jsp">
                <security:concurrency-control max-sessions="1"
                                              error-if-maximum-exceeded="true"
                                              expired-url="/login.jsp"/>
                <!--max-sessions:最大同时登录数 -->
                <!--error-if-maximum-exceeded: true 新的登陆会失败,除非之前的登陆失效; false:新的登陆会踢掉之前的登陆-->
                <!--expired-url: 失效后跳转的页面-->
        </security:session-management>
    </security:http>

    <!-- 后台管理权限认证 -->
    <security:authentication-manager alias="authenticationManager">
        <!--定义认证提供接口: 自定义用户认证类  -->
        <security:authentication-provider user-service-ref="myDetailsServiceImpl">
            <!-- TODO 定义密码加密算法 -->
        </security:authentication-provider>
    </security:authentication-manager>

    <!-- 自定义认证成功逻辑  -->
    <beans:bean id="customAuthenticationSuccessHandler"
                class="com.tz.tpcs.service.security.CustomAuthenticationSuccessHandler">
        <beans:property name="defaultTargetUrl" value="/loginSuccess"/>
        <beans:property name="alwaysUseDefaultTargetUrl" value="true"/>
    </beans:bean>

    <!-- 自定义认证成功逻辑 -->
    <beans:bean id="customAuthenticationFailureHandler"
                class="com.tz.tpcs.service.security.CustomAuthenticationFailureHandler">
        <!--错误提示页面-->
        <beans:property name="defaultFailureUrl" value="/login.jsp"/>
        <!--最大密码输入错误次数, 否则账号锁定-->
        <beans:property name="maxLoginFailureCount" value="3"/>
        <!--使用服务器转发到错误页面-->
        <beans:property name="useForward" value="true"/>
    </beans:bean>

</beans:beans>